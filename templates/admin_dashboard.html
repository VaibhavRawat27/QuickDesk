{% extends 'base.html' %}
{% block content %}

<h2>Admin Dashboard</h2>
<hr class="my-4">

<!-- 🔍 Global Search
<form method="GET" action="{{ url_for('admin_dashboard') }}" class="mb-4">
  <input type="text" name="search" placeholder="Search users or tickets..." class="form-control" value="{{ request.args.get('search', '') }}">
</form> -->

<!-- 👥 USER ROLE FILTER TABS -->
<ul class="nav nav-tabs mb-3">
  {% for role, label, count in [('all', 'All', total_users), ('user', 'Employees', employee_count), ('agent', 'Support Agents', agent_count), ('admin', 'Admins', admin_count)] %}
  <li class="nav-item">
    <a class="nav-link {% if current_user_role == role %}active{% endif %}" href="{{ url_for('admin_dashboard', user_role=role, status=current_status) }}">{{ label }} ({{ count }})</a>
  </li>
  {% endfor %}
</ul>

<!-- 📋 USERS TABLE -->
<h4>All Users</h4>
<input type="text" class="form-control mb-2" placeholder="Search Users..." onkeyup="filterTable('usersTable', this.value)">
<table class="table table-bordered mb-5" id="usersTable">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Email</th>
      <th>Name</th>
      <th>Role</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for user in users %}
    <tr>
      <td>{{ user.id }}</td>
      <td>{{ user.email }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.role }}</td>
      <td>
        {% if user.role != 'admin' %}
        <form method="POST" action="{{ url_for('toggle_user_status', user_id=user.id) }}">
          {% if user.is_active %}
          <button class="btn btn-sm btn-danger">Deactivate</button>
          {% else %}
          <button class="btn btn-sm btn-success">Activate</button>
          {% endif %}
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ➕ Add Support Agent -->
<h4>Add New Support Agent</h4>
<form method="POST" action="{{ url_for('create_agent') }}" class="mb-5">
  <div class="row g-2">
    <div class="col-md-4"><input type="text" name="name" class="form-control" placeholder="Name" required></div>
    <div class="col-md-4"><input type="email" name="email" class="form-control" placeholder="Email" required></div>
    <div class="col-md-4"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
  </div>
  <button class="btn btn-primary mt-3">Create Agent</button>
</form>

<!-- 📂 Category Management -->
<h4>Manage Categories</h4>
<form method="POST" action="{{ url_for('add_category') }}" class="mb-3">
  <div class="input-group">
    <input type="text" name="category" class="form-control" placeholder="New Category" required>
    <button class="btn btn-success">Add</button>
  </div>
</form>

<input type="text" class="form-control mb-2" placeholder="Search Categories..." onkeyup="filterTable('categoriesTable', this.value)">
<table class="table table-hover mb-5" id="categoriesTable">
  <thead><tr><th>Category</th><th>Actions</th></tr></thead>
  <tbody>
    {% for cat in categories %}
    <tr>
      <td>{{ cat.name }}</td>
      <td>
        <a href="{{ url_for('filter_by_category', category=cat.name) }}" class="btn btn-sm btn-info">View Tickets</a>
        <a href="{{ url_for('delete_category', category_id=cat.id) }}" class="btn btn-sm btn-danger">Delete</a>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="2" class="text-center">No categories available.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- TICKETS FILTER TABS -->
<ul class="nav nav-pills mb-3">
  {% for label, count in [('all', all_count), ('Open', open_count), ('In Progress', inprogress_count), ('Resolved', resolved_count), ('Closed', closed_count)] %}
  <li class="nav-item">
    <a class="nav-link {% if current_status == label %}active{% endif %}" href="{{ url_for('admin_dashboard', status=label) }}">
      {{ label }} ({{ count }})
    </a>
  </li>
  {% endfor %}
</ul>

<!-- 🧾 TICKETS TABLE -->
<h4>Tickets</h4>
<input type="text" class="form-control mb-2" placeholder="Search Tickets..." onkeyup="filterTable('ticketsTable', this.value)">
<table class="table table-striped" id="ticketsTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Subject</th>
      <th>User</th>
      <th>Status</th>
      <th>Created At</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for ticket in tickets %}
    <tr>
      <td>{{ ticket.id }}</td>
      <td>{{ ticket.subject }}</td>
      <td>{{ ticket.owner.name }}</td>
      <td>
        {% if ticket.status == 'Open' %}
        <span class="badge bg-danger">🔓 Open</span>
        {% elif ticket.status == 'In Progress' %}
        <span class="badge bg-warning text-dark">🔧 In Progress</span>
        {% elif ticket.status == 'Resolved' %}
        <span class="badge bg-success">✅ Resolved</span>
        {% elif ticket.status == 'Closed' %}
        <span class="badge bg-secondary">🔒 Closed</span>
        {% else %}
        <span class="badge bg-dark">{{ ticket.status }}</span>
        {% endif %}
      </td>
      <td>{{ ticket.created_at.strftime('%Y-%m-%d') }}</td>
      <td>
        <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-primary">View</a>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="text-center">No tickets found for this status.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- 📊 Ticket Counts by Category -->
<div class="row mt-5">
  <div class="col-md-6">
    <h5>📂 Ticket Counts by Category</h5>
    <input type="text" class="form-control mb-2" placeholder="Search Category Stats..." onkeyup="filterTable('categoryStatsTable', this.value)">
    <table class="table table-bordered table-sm" id="categoryStatsTable">
      <thead><tr><th>Category</th><th>Ticket Count</th></tr></thead>
      <tbody>
        {% for cat in categories %}
        <tr><td>{{ cat.name }}</td><td>{{ cat.ticket_count }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 👥 User Role Distribution -->
  <div class="col-md-6">
    <h5>👥 User Role Distribution</h5>
    <table class="table table-bordered table-sm">
      <thead><tr><th>Role</th><th>Count</th></tr></thead>
      <tbody>
        <tr><td>Admins</td><td>{{ admin_count }}</td></tr>
        <tr><td>Support Agents</td><td>{{ agent_count }}</td></tr>
        <tr><td>Employees</td><td>{{ employee_count }}</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- 🔍 Table Filtering Script -->
<script>
function filterTable(tableId, query) {
  const input = query.toLowerCase();
  const rows = document.querySelectorAll(`#${tableId} tbody tr`);
  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(input) ? '' : 'none';
  });
}
</script>

{% endblock %}
