{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Your Tickets</h2>
  <a href="{{ url_for('create_ticket') }}" class="btn btn-success">Create Ticket</a>

</div>



<!-- 🔍 Filters Section -->
<form method="GET" action="{{ url_for('dashboard') }}" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="search" class="form-control" placeholder="Search subject..." value="{{ request.args.get('search', '') }}">
  </div>
  <div class="col-md-2">
    <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
  </div>
  <div class="col-md-2">
    <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
  </div>
  <div class="col-md-2">
    <select name="category" class="form-select">
      <option value="">All Categories</option>
      {% for cat in categories %}
        <option value="{{ cat.name }}" {% if request.args.get('category') == cat.name %}selected{% endif %}>
          {{ cat.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <select name="sort" class="form-select">
      <option value="desc" {% if request.args.get('sort', 'desc') == 'desc' %}selected{% endif %}>Newest First</option>
      <option value="asc" {% if request.args.get('sort') == 'asc' %}selected{% endif %}>Oldest First</option>
    </select>
  </div>
  <div class="col-md-1">
    <button class="btn btn-primary w-100">Apply</button>
  </div>
</form>

<!-- 🟢 Ticket Status Tabs -->
<ul class="nav nav-pills mb-3">
  {% for label, count in [('all', all_count), ('Open', open_count), ('In Progress', inprogress_count), ('Resolved', resolved_count), ('Closed', closed_count)] %}
  <li class="nav-item">
    <a class="nav-link {% if current_status == label %}active{% endif %}"
       href="{{ url_for('dashboard',
                        status=label,
                        search=request.args.get('search', ''),
                        start_date=request.args.get('start_date', ''),
                        end_date=request.args.get('end_date', ''),
                        category=request.args.get('category', ''),
                        sort=request.args.get('sort', 'desc')) }}">
      {{ label }} ({{ count }})
    </a>
  </li>
  {% endfor %}
</ul>

<!-- 🎫 Tickets Table -->
<table class="table table-striped table-bordered">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Subject</th>
      <th>Status</th>
      <th>Category</th>
      <th>Created At</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for ticket in tickets %}
    <tr>
      <td>{{ ticket.id }}</td>
      <td>{{ ticket.subject }}</td>
      <td>
        {% if ticket.status == 'Open' %}
          <span class="badge bg-danger">🔓 Open</span>
        {% elif ticket.status == 'In Progress' %}
          <span class="badge bg-warning text-dark">🔧 In Progress</span>
        {% elif ticket.status == 'Resolved' %}
          <span class="badge bg-success">✅ Resolved</span>
        {% elif ticket.status == 'Closed' %}
          <span class="badge bg-secondary">🔒 Closed</span>
        {% else %}
          <span class="badge bg-dark">{{ ticket.status }}</span>
        {% endif %}
      </td>
      <td>{{ ticket.category or '—' }}</td>
      <td>{{ ticket.created_at.strftime('%Y-%m-%d') }}</td>
      <td>
        <a href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-info">View</a>
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="6" class="text-center">No tickets found matching your filters.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
